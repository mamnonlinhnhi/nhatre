<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chá»‰nh sá»­a bÃ i Ä‘Äƒng</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }
    input, textarea {
      width: 100%;
      margin-bottom: 12px;
      padding: 8px;
      font-size: 16px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
    }
    #status {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>ğŸ“ ÄÄƒng bÃ i má»›i</h2>

  <input type="text" id="title" placeholder="TiÃªu Ä‘á» bÃ i viáº¿t">
  <textarea id="text" rows="5" placeholder="Ná»™i dung bÃ i viáº¿t"></textarea>
  <input type="text" id="image" placeholder="URL hÃ¬nh áº£nh (náº¿u cÃ³)">
  <input type="password" id="token" placeholder="Nháº­p GitHub Token cá»§a báº¡n">
  <button onclick="savePost()">ğŸ’¾ LÆ°u bÃ i Ä‘Äƒng</button>

  <p id="status"></p>

  <script>
    const repo = 'mamnonlinhnhi/nhatre';
    const filePath = 'data.json';

    async function savePost() {
      const title = document.getElementById('title').value.trim();
      const text = document.getElementById('text').value.trim();
      const image = document.getElementById('image').value.trim();
      const token = document.getElementById('token').value.trim();
      const status = document.getElementById('status');

      if (!title || !text || !token) {
        status.innerText = 'â— Vui lÃ²ng nháº­p Ä‘áº§y Ä‘á»§ tiÃªu Ä‘á», ná»™i dung vÃ  token.';
        return;
      }

      const newPost = { title, text, image };

      try {
        // Láº¥y ná»™i dung hiá»‡n táº¡i cá»§a data.json
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();
        const sha = data.sha;
        const existingContent = JSON.parse(decodeURIComponent(escape(atob(data.content))));
        
        // ThÃªm bÃ i má»›i vÃ o Ä‘áº§u danh sÃ¡ch
        existingContent.unshift(newPost);

        const updatedContent = btoa(unescape(encodeURIComponent(JSON.stringify(existingContent, null, 2))));

        // Gá»­i PUT Ä‘á»ƒ cáº­p nháº­t file
        const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
          method: 'PUT',
          headers: {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `ThÃªm bÃ i Ä‘Äƒng má»›i: ${title}`,
            content: updatedContent,
            sha: sha
          })
        });

        if (updateRes.ok) {
          status.innerText = 'âœ… BÃ i Ä‘Äƒng Ä‘Ã£ Ä‘Æ°á»£c lÆ°u thÃ nh cÃ´ng!';
        } else {
          status.innerText = 'âŒ Lá»—i khi lÆ°u bÃ i Ä‘Äƒng.';
          console.error(await updateRes.json());
        }
      } catch (err) {
        status.innerText = 'âŒ KhÃ´ng thá»ƒ Ä‘á»c hoáº·c ghi file data.json.';
        console.error(err);
      }
    }
  </script>
</body>
</html>
