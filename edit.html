<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chỉnh sửa bài đăng</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }
    input, textarea {
      width: 100%;
      margin-bottom: 12px;
      padding: 8px;
      font-size: 16px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
    }
    #status {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>📝 Đăng bài mới</h2>

  <input type="text" id="title" placeholder="Tiêu đề bài viết">
  <textarea id="text" rows="5" placeholder="Nội dung bài viết"></textarea>
  <input type="text" id="image" placeholder="URL hình ảnh (nếu có)">
  <input type="password" id="token" placeholder="Nhập GitHub Token của bạn">
  <button onclick="savePost()">💾 Lưu bài đăng</button>

  <p id="status"></p>

  <script>
    const repo = 'mamnonlinhnhi/nhatre';
    const filePath = 'data.json';

    async function savePost() {
      const title = document.getElementById('title').value.trim();
      const text = document.getElementById('text').value.trim();
      const image = document.getElementById('image').value.trim();
      const token = document.getElementById('token').value.trim();
      const status = document.getElementById('status');

      if (!title || !text || !token) {
        status.innerText = '❗ Vui lòng nhập đầy đủ tiêu đề, nội dung và token.';
        return;
      }

      const newPost = { title, text, image };

      try {
        // Lấy nội dung hiện tại của data.json
        const res = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();
        const sha = data.sha;
        const existingContent = JSON.parse(decodeURIComponent(escape(atob(data.content))));
        
        // Thêm bài mới vào đầu danh sách
        existingContent.unshift(newPost);

        const updatedContent = btoa(unescape(encodeURIComponent(JSON.stringify(existingContent, null, 2))));

        // Gửi PUT để cập nhật file
        const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
          method: 'PUT',
          headers: {
            Authorization: `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Thêm bài đăng mới: ${title}`,
            content: updatedContent,
            sha: sha
          })
        });

        if (updateRes.ok) {
          status.innerText = '✅ Bài đăng đã được lưu thành công!';
        } else {
          status.innerText = '❌ Lỗi khi lưu bài đăng.';
          console.error(await updateRes.json());
        }
      } catch (err) {
        status.innerText = '❌ Không thể đọc hoặc ghi file data.json.';
        console.error(err);
      }
    }
  </script>
</body>
</html>
